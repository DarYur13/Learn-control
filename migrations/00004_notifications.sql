-- +goose Up
-- +goose StatementBegin

-- –¢–∏–ø—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
CREATE TYPE notification_type AS ENUM (
    'INIT_BRIEF',
    'REFRESH_BRIEF_FIRST',
    'REFRESH_BRIEF_SECOND'
);

-- –¢–∞–±–ª–∏—Ü–∞ —à–∞–±–ª–æ–Ω–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE TABLE IF NOT EXISTS  notification_types_templates (
    notification_type notification_type NOT NULL PRIMARY KEY,
    subject_template VARCHAR(100) NOT NULL,
    body_template TEXT NOT NULL
);

-- –®–∞–±–ª–æ–Ω—ã –¥–ª—è —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
INSERT INTO notification_types_templates (notification_type, subject_template, body_template) VALUES
    ('INIT_BRIEF', '–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {instructor_name}!\n–í –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ "{department}" –ø—Ä–∏–Ω—è—Ç –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ {employee_name} –Ω–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å {position}.\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –µ–º—É –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è {today_date}.\n\n–ü—Ä–∏–∫—Ä–µ–ø–ª—è—é –ª–∏—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∏—Å—Ç—Ä—É–∫—Ç–∞–∂–∞.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º\nLearn-Control notification system'),
    ('REFRESH_BRIEF_FIRST', '–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {instructor_name}!\n–ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è —Å—Ä–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞(–æ–≤) –í–∞—à–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:\n{employee_name}\n\n–ü—Ä–∏–∫—Ä–µ–ø–ª—è—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞.\n\n{download_link}\n\nüìå –û–±—Ä–∞—â–∞–µ–º –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –ª–∏—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –≤ –¥–µ–Ω—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞.\n–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–∞—Ç–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É —É—á—ë—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π.\n\n–≠—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞ 1 –º–µ—Å—è—Ü –¥–æ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è –∫—Ä–∞–π–Ω–µ–≥–æ —Å—Ä–æ–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞. –ï—Å–ª–∏ –ª–∏—Å—Ç –Ω–µ –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 20 –¥–Ω–µ–π, –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—É–¥–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞ 10 –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–æ–∫–∞.\n\n–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –æ—Ç–¥–µ–ª –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞.\n\nüì© –≠—Ç–æ –ø–∏—Å—å–º–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º\nLearn-Control notification system'),
    ('REFRESH_BRIEF_SECOND', '–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {instructor_name}!\n–í–Ω–∏–º–∞–Ω–∏–µ! –î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–æ–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞(–æ–≤) –í–∞—à–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å 10 –¥–Ω–µ–π:\n{employee_name}\n\n–ü—Ä–∏–∫—Ä–µ–ø–ª—è—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞.\n\n{download_link}\n\nüìå –ù–∞–ø–æ–º–∏–Ω–∞–µ–º: –ª–∏—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –≤ –¥–µ–Ω—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞.\n–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–∞—Ç–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É —É—á—ë—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π.\n\n‚ÄºÔ∏è–ü—Ä–æ—Å–∏–º –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ –¥–æ {retraining_date} –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞.\n\n–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –æ—Ç–¥–µ–ª –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞.\n\nüì© –≠—Ç–æ –ø–∏—Å—å–º–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º\nLearn-Control notification system')
ON CONFLICT DO NOTHING;

-- –¢–∞–±–ª–∏—Ü–∞ –æ—á–µ—Ä–µ–¥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE TABLE IF NOT EXISTS notifications_queue (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
    training_id INTEGER NOT NULL REFERENCES trainings(id) ON DELETE CASCADE,
    notification_type notification_type NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    sent BOOLEAN NOT NULL DEFAULT FALSE,
    sent_at TIMESTAMP
);


-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
DROP TABLE IF EXISTS notification_types_templates;
DROP TABLE IF EXISTS notification_queue;
DROP TYPE IF EXISTS notification_type;
-- +goose StatementEnd
